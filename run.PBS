#!/bin/bash
#SBATCH --account punim0980
#SBATCH --partition gpu-a100
#SBATCH --array=0-0
#SBATCH --qos=normal

#SBATCH --gres=gpu:1
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=1
#SBATCH --cpus-per-task=8
#SBATCH --mem=112G
#SBATCH --time=6:00:00
#SBATCH --output dino_vit_tiny_imagenette.%A_%a.out
#SBATCH --open-mode=truncate
#SBATCH --job-name=dino_vit_tiny_imagenette
#SBATCH --mail-type=ALL
#SBATCH --mail-user=nathaniel.bloomfield@unimelb.edu.au

# sinteractive --account=punim0980 --time=360 --ntasks=1 --mem=112gb --cpus-per-task 8 -p gpu-a100 --gres=gpu:1

# module load Python/3.10.4
# module load CUDA/11.7.0
# virtualenv /data/cephfs/punim0980/venvs/ood_test
# source /data/cephfs/punim0980/venvs/ood_test/bin/activate
# PIP_CACHE_DIR=/data/cephfs/punim0980/venvs/cache pip3 install -r requirements.txt

# module purge
export mysystem=spartan
export env_seed=$SLURM_ARRAY_TASK_ID
export HYDRA_FULL_ERROR=1

export WORLD_SIZE=1
export RANK=0
export LOCAL_RANK=0
export MASTER_ADDR='127.0.0.1'
export MASTER_PORT='29500'

module load Python/3.10.4
module load CUDA/11.7.0
source /data/cephfs/punim0980/venvs/ood_test/bin/activate

cd /data/cephfs/punim0980/tests/cider/

python train_cider.py \
    --in-dataset CIFAR-10 \
    --id_loc datasets/CIFAR10 \
    --gpu 0 \
    --model resnet18 \
    --loss cider \
    --epochs 500 \
    --proto_m 0.95 \
    --feat_dim 128 \
    --batch-size 512 \
    --w 2 \
    --cosine \
    --save-epoch 100


##Log this job's resource usage stats###
my-job-stats -a -n -s
##